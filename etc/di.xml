<?xml version="1.0"?>
<!--
/**
 * NavinDBhudiya ProductRecommendation
 *
 * @category  NavinDBhudiya
 * @package   NavinDBhudiya_ProductRecommendation
 * @author    Navin Bhudiya
 * @license   MIT License
 */
-->
<config xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:noNamespaceSchemaLocation="urn:magento:framework:ObjectManager/etc/config.xsd">

    <!-- API Interfaces -->
    <preference for="NavinDBhudiya\ProductRecommendation\Api\ChromaClientInterface"
                type="NavinDBhudiya\ProductRecommendation\Service\ChromaClient"/>

    <preference for="NavinDBhudiya\ProductRecommendation\Api\EmbeddingProviderInterface"
                type="NavinDBhudiya\ProductRecommendation\Service\Embedding\EmbeddingProviderFactory"/>

    <preference for="NavinDBhudiya\ProductRecommendation\Api\RecommendationServiceInterface"
                type="NavinDBhudiya\ProductRecommendation\Service\RecommendationService"/>

    <preference for="NavinDBhudiya\ProductRecommendation\Api\Data\ProductEmbeddingInterface"
                type="NavinDBhudiya\ProductRecommendation\Model\Data\ProductEmbedding"/>

    <preference for="NavinDBhudiya\ProductRecommendation\Api\Data\RecommendationResultInterface"
                type="NavinDBhudiya\ProductRecommendation\Model\Data\RecommendationResult"/>

    <preference for="NavinDBhudiya\ProductRecommendation\Api\PersonalizedRecommendationInterface"
                type="NavinDBhudiya\ProductRecommendation\Service\PersonalizedRecommendationService"/>

    <preference for="NavinDBhudiya\ProductRecommendation\Api\Data\CustomerProfileInterface"
                type="NavinDBhudiya\ProductRecommendation\Model\Data\CustomerProfile"/>

    <preference for="NavinDBhudiya\ProductRecommendation\Api\PersonalizedRecommendationManagementInterface"
                type="NavinDBhudiya\ProductRecommendation\Model\PersonalizedRecommendationManagement"/>

    <preference for="NavinDBhudiya\ProductRecommendation\Api\Data\LlmRankingInterface"
                type="NavinDBhudiya\ProductRecommendation\Model\LlmRanking"/>

    <preference for="NavinDBhudiya\ProductRecommendation\Api\LlmRankingRepositoryInterface"
                type="NavinDBhudiya\ProductRecommendation\Model\LlmRankingRepository"/>

    <!-- Embedding Provider Pool -->
    <type name="NavinDBhudiya\ProductRecommendation\Service\Embedding\EmbeddingProviderFactory">
        <arguments>
            <argument name="providers" xsi:type="array">
                <item name="chromadb" xsi:type="string">NavinDBhudiya\ProductRecommendation\Service\Embedding\ChromaDBEmbeddingProvider</item>
            </argument>
        </arguments>
    </type>

    <!-- Virtual Types for Logging -->
    <virtualType name="NavinDBhudiya\ProductRecommendation\Logger\Handler" type="Magento\Framework\Logger\Handler\Base">
        <arguments>
            <argument name="fileName" xsi:type="string">/var/log/product_recommendation.log</argument>
        </arguments>
    </virtualType>

    <virtualType name="NavinDBhudiya\ProductRecommendation\Logger\Logger" type="Magento\Framework\Logger\Monolog">
        <arguments>
            <argument name="handlers" xsi:type="array">
                <item name="debug" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Handler</item>
            </argument>
        </arguments>
    </virtualType>

    <!-- Inject Logger -->
    <type name="NavinDBhudiya\ProductRecommendation\Service\ChromaClient">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <!-- Core Recommendation Service with LLM Re-Ranking -->
    <type name="NavinDBhudiya\ProductRecommendation\Service\RecommendationService">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
            <argument name="llmReRanker" xsi:type="object">NavinDBhudiya\ProductRecommendation\Service\LlmReRanker</argument>
        </arguments>
    </type>

    <type name="NavinDBhudiya\ProductRecommendation\Service\PersonalizedRecommendationService">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <type name="NavinDBhudiya\ProductRecommendation\Service\BehaviorCollector\BrowsingHistoryCollector">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <type name="NavinDBhudiya\ProductRecommendation\Service\BehaviorCollector\PurchaseHistoryCollector">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <type name="NavinDBhudiya\ProductRecommendation\Service\BehaviorCollector\WishlistCollector">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <type name="NavinDBhudiya\ProductRecommendation\Observer\ProductViewTracker">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <type name="NavinDBhudiya\ProductRecommendation\Observer\CustomerLoginRefresh">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <type name="NavinDBhudiya\ProductRecommendation\Cron\RefreshCustomerProfiles">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <!-- AI Enhancement Services -->
    <type name="NavinDBhudiya\ProductRecommendation\Service\DiversityFilter">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <type name="NavinDBhudiya\ProductRecommendation\Service\RecommendationExplainer">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <type name="NavinDBhudiya\ProductRecommendation\Service\TrendingBooster">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <type name="NavinDBhudiya\ProductRecommendation\Cron\RefreshTrending">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <!-- LLM Re-Ranking Services -->

    <type name="NavinDBhudiya\ProductRecommendation\Service\LlmReRanker">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <type name="NavinDBhudiya\ProductRecommendation\Service\Llm\ClaudeProvider">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <type name="NavinDBhudiya\ProductRecommendation\Service\Llm\OpenAiProvider">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <type name="NavinDBhudiya\ProductRecommendation\Service\ContextBuilder">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <type name="NavinDBhudiya\ProductRecommendation\Model\LlmRankingRepository">
        <arguments>
            <argument name="logger" xsi:type="object">NavinDBhudiya\ProductRecommendation\Logger\Logger</argument>
        </arguments>
    </type>

    <!-- CLI Commands -->
    <type name="Magento\Framework\Console\CommandList">
        <arguments>
            <argument name="commands" xsi:type="array">
                <item name="recommendation_index" xsi:type="object">NavinDBhudiya\ProductRecommendation\Console\Command\IndexProducts</item>
                <item name="recommendation_test" xsi:type="object">NavinDBhudiya\ProductRecommendation\Console\Command\TestConnection</item>
                <item name="recommendation_clear" xsi:type="object">NavinDBhudiya\ProductRecommendation\Console\Command\ClearCollection</item>
                <item name="recommendation_refresh_profiles" xsi:type="object">NavinDBhudiya\ProductRecommendation\Console\Command\RefreshProfiles</item>
                <item name="recommendation_refresh_trending" xsi:type="object">NavinDBhudiya\ProductRecommendation\Console\Command\RefreshTrending</item>
            </argument>
        </arguments>
    </type>

    <!-- Indexer -->
    <type name="Magento\Framework\Indexer\IndexerRegistry">
        <arguments>
            <argument name="indexers" xsi:type="array">
                <item name="product_recommendation_embedding" xsi:type="string">product_recommendation_embedding</item>
            </argument>
        </arguments>
    </type>

    <!-- Cache Type -->
    <type name="Magento\Framework\App\Cache\TypeList">
        <arguments>
            <argument name="typeList" xsi:type="array">
                <item name="product_recommendation" xsi:type="array">
                    <item name="name" xsi:type="string">product_recommendation</item>
                    <item name="label" xsi:type="string">AI Product Recommendations</item>
                    <item name="description" xsi:type="string">Cached AI product recommendations</item>
                </item>
            </argument>
        </arguments>
    </type>

</config>
